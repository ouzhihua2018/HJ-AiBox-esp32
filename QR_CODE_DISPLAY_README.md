# 二维码显示功能说明

## 功能概述

本项目实现了在240*240 TFT屏幕上显示二维码的功能，支持从HTTP链接下载PNG格式的二维码图片并全屏显示，自动处理不同尺寸的图片。

## 主要功能

### 1. ShowQRCode(const std::string& qrUrl)
- **功能**: 显示二维码
- **参数**: `qrUrl` - 二维码图片的HTTP链接（PNG格式）
- **行为**: 
  - 从URL下载PNG格式的二维码图片
  - 解析PNG文件头信息（IHDR块）
  - 自动缩放图片以适应240*240屏幕
  - 保持图片宽高比，居中显示
  - 将PNG转换为RGB565格式

### 2. HideQRCode()
- **功能**: 隐藏二维码显示
- **行为**: 隐藏二维码图片，恢复表情和聊天消息的显示

### 3. TestQRCodeUrl()
- **功能**: 测试指定的二维码URL
- **行为**: 使用预设的测试URL进行二维码显示测试

## 实现细节

### PNG图片处理
- 支持PNG格式的二维码图片
- 自动解析PNG文件头（IHDR块）
- 提取图片尺寸、位深度、颜色类型等信息
- 智能缩放算法，保持图片宽高比
- 居中显示，超出部分用白色背景填充

### 图片缩放算法
1. **计算缩放比例**: `scale = min(240/width, 240/height)`
2. **保持宽高比**: 避免图片变形
3. **居中显示**: 计算偏移量使图片居中
4. **背景填充**: 图片区域外填充白色背景

### 显示方式
1. **全屏图片显示**: PNG图片解码后缩放并居中显示
2. **降级文本显示**: 如果下载或解码失败，显示URL文本和二维码占位符

### 界面管理
- 显示二维码时自动隐藏表情和聊天消息
- 隐藏二维码时自动恢复表情和聊天消息的显示
- 使用LVGL框架进行界面管理

## 使用方法

### 基本使用
```cpp
// 显示PNG格式的二维码（自动缩放）
display_->ShowQRCode("https://example.com/qr-code.png");

// 隐藏二维码
display_->HideQRCode();

// 测试指定的二维码URL
display_->TestQRCodeUrl();
```

### 在项目中的集成
```cpp
// 在初始化时显示二维码
if (!ota_.GetWeChatCodeUrl().empty()) {
    display_->ShowQRCode(ota_.GetWeChatCodeUrl());
} else {
    // 测试指定的二维码URL
    display_->TestQRCodeUrl();
}
```

## 技术规格

### 屏幕规格
- **分辨率**: 240*240像素
- **颜色格式**: RGB565
- **显示方式**: 全屏显示，自动缩放

### 图片要求
- **格式**: PNG
- **支持尺寸**: 任意尺寸（自动缩放）
- **推荐尺寸**: 240*240像素（无需缩放）
- **颜色**: 黑白二维码（自动转换为RGB565）

### 缩放特性
- **最大支持**: 10000*10000像素
- **缩放算法**: 等比例缩放
- **显示方式**: 居中显示
- **背景**: 白色填充

## 错误处理

- **网络错误**: 自动降级为文本显示
- **PNG格式错误**: 自动降级为文本显示
- **尺寸过大**: 拒绝处理超过10000*10000的图片
- **解码失败**: 显示二维码样式的占位符图案
- **空URL**: 记录错误日志，不执行任何操作

## 依赖项

- ESP32 HTTP客户端
- LVGL图形库
- zlib库（用于PNG处理）
- FreeRTOS任务管理
- C++标准库（vector, string, algorithm）

## 注意事项

1. 确保设备已连接到网络
2. 图片URL必须是可访问的HTTP链接
3. 支持任意尺寸的PNG图片，自动缩放
4. 显示二维码时会暂时隐藏其他界面元素
5. PNG解码功能包含完整的文件头解析
6. 缩放算法保持图片宽高比，避免变形

## 日志输出

功能会输出详细的日志信息：
- `ESP_LOGI`: 成功操作信息（下载、解析、缩放、显示）
- `ESP_LOGW`: 警告信息（如降级为文本显示）
- `ESP_LOGE`: 错误信息（如网络连接失败、PNG格式错误、尺寸过大）

## 测试功能

提供了测试URL功能：
```cpp
// 测试指定的二维码URL
display_->TestQRCodeUrl();
```

测试URL: `https://core.device.lekale.com/data/images/qrcode/80152519e39c5d-1d1c-4e8a-a7b2-d7622dd7fbe4.png`

## 扩展功能

可以考虑添加以下功能：
1. 完整的PNG解码器（包括zlib解压缩）
2. 图片缓存功能
3. 二维码生成功能（本地生成二维码）
4. 支持更多图片格式（JPG、BMP等）
5. 图片旋转功能
6. 多种缩放模式（拉伸、裁剪等）

## 性能优化

- 使用静态内存分配减少内存碎片
- 图片数据直接转换为RGB565格式
- 智能缩放算法，减少不必要的计算
- 边界检查，防止数组越界
- 错误处理，提高系统稳定性 